---
title: "1-DataAnalysis"
author: "Arlie McCarthy"
date: "02/05/2021"
output: html_document
---
# Code Setup and Data Import - because that is super-important

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(vegan)
library(tidyverse)
library(readr)
library(here)
library(janitor)
```

I have one data file with the count data from lab processing. The file needs some wrangling to calculate a density (counts per cm2) for each quadrat sampled.

```{r calculating density}
taxon_count_data <- read_csv(here("data", "taxon_count_data_internal_pipework.csv"))
taxon_density <- taxon_count_data %>% 
  clean_names() %>% 
  mutate(id = paste(area, quadrat_number, sep = "_")) %>% #some quadrats had multiple 'sample' so changed to just area and quadrat
  mutate(taxon_verified = case_when(taxon == "mussel" ~ "mytilus_sp", 
                                    taxon == "acorn barnacle" ~ "amphibalanus_improvisus",
                                    taxon == "barnacle type 2" ~ "amphibalanus_amphitrite",
                                    taxon == "clam" ~ "hiatella_sp",
                                    taxon == "c.f. Jassa" ~ "jassa_marmorata", 
                                    taxon == "acorn barnacle ribbed" ~ "austrominius_modestus",
                                    taxon == "crab" ~ "carcinus_maenas",
                                    taxon == "encrusting bryozoan" ~ "membranipora_membranacea",
                                    taxon == "white tufted bryozoan" | taxon == "type 2 white tufted bryozoan" ~ "tricellaria_inopinata",
                                    taxon == "round amphipod" | taxon == "green eye amphipod" ~ "stenothoidae",
                                    taxon == "c.f. Conchoderma" ~ "conchoderma_auritum", 
                                    taxon == "brown bryozoan" ~ "bugula_neritina",
                                    taxon == "c.f. Corophium" ~ "monocorophium_sextonae",
                                    taxon == "caprellid" ~ "caprella_mutica",
                                    taxon == "c.f. Schizoporella" ~ "cryptosula_pallasiana",
                                    taxon == "spiked encrusting bryo" ~ "electra_pilosa",
                                    taxon == "mystery tunicates? large anemone?" ~ "clear_tunicates",
                                    taxon == "c.f. Caprella equilibra" ~ "caprella_equilibra",
                                    TRUE ~ taxon
                                    )) %>% 
  group_by(id, taxon_verified, taxon_grouping_qualifier, area, stage, quadrat_number) %>% 
  mutate(density = count*multiply_by/divide_by/area_sampled*100) %>% #counts per m2
  summarise(avg_density = mean(density))
site_info <- taxon_density %>% 
  ungroup() %>% 
  select(id, area, stage, quadrat_number) %>% 
  group_by(id) %>% 
  slice(1)
```

# Preparing Data for ordination

I take my data from counts to a community matrix, with species as variables and rows as samples

```{r nMDS preparation}
community_matrix_rough <- taxon_density %>% 
  mutate(full_taxon_group = paste(taxon_verified, taxon_grouping_qualifier, sep = "_")) %>% 
  filter(full_taxon_group != "mytilus sp_valves intact, no tissue",
         full_taxon_group != "NA_NA",
         full_taxon_group != "mussel sp_valves intact",
         full_taxon_group != "insect_NA",
         full_taxon_group != "crab_exoskeleton_NA") %>% 
  group_by(id, taxon_verified) %>% 
  summarise(avg_density = sum(avg_density)) %>% 
  pivot_wider(names_from = taxon_verified, values_from = avg_density, values_fill = 0) %>% 
  ungroup()
#community_matrix_rough[is.na(community_matrix_rough)] <- 0
community_matrix <- community_matrix_rough %>% 
  clean_names() %>% 
  column_to_rownames(var = "id") %>% 
  filter_all(any_vars(. != 0))
```

## nMDS

```{r nMDS}
internal_pipe_nmds <- metaMDS(community_matrix, distance = "bray", k = 2, trymax = 500)
internal_pipe_nmds
data_scores <- as.data.frame(scores(internal_pipe_nmds))  #Using the scores function from vegan to extract the site scores and convert to a data.frame
data_scores$site <- rownames(internal_pipe_nmds)  # create a column of site names, from the rownames of data.scores
data_scores <- data_scores %>% 
  rownames_to_column(var = "id") %>% 
  left_join(site_info)
data_scores$n_species <- specnumber(community_matrix, MARGIN = 1)
data_scores$shannon <- diversity(community_matrix, index = "shannon")
data_scores$simpson <- diversity(community_matrix, index = "simpson")
species_scores <- as.data.frame(scores(internal_pipe_nmds, "species"))  #Using the scores function from vegan to extract the species scores and convert to a data.frame
species_scores$species <- rownames(species_scores)

```

Plotting with ggplot
```{r}
ggplot() + 
  #geom_text(data=species_scores,aes(x=NMDS1,y=NMDS2,label=species),alpha=0.5) +  # add the species labels
  #geom_point(data=data_scores,aes(x=NMDS1,y=NMDS2,shape=as_factor(stage), colour= as_factor(area)),size=3) + # add the point markers
  geom_point(data=data_scores,aes(x=NMDS1,y=NMDS2,shape = as_factor(stage), colour = n_species),size=3) + # add the point markers
  #geom_text(data=data_scores,aes(x=NMDS1,y=NMDS2,label=area),size=6,vjust=0) +  # add the site labels
  coord_equal() +
  theme_bw()
```
Checking the nMDS

```{r}
goodness(internal_pipe_nmds) # Produces a results of test statistics for goodness of fit for each point

stressplot(internal_pipe_nmds) # Produces a Shepards diagram
```


# Density of different groups

Here I will make a stacked bar chart to show mean density of different taxonomic groups at each stage of the pipework

```{r}
mean_density_stage <- taxon_density %>% 
  group_by(id, taxon_verified, area, stage) %>% 
  summarise(avg_density = sum(avg_density)) %>% #this ensures that there is only one number per taxa per sample
  ungroup() %>% 
  filter(!is.na(avg_density)) %>% 
  group_by(taxon_verified, stage) %>% 
  summarise(avg_density = mean(avg_density))
```

Now to plot it. This plot will be aligned with a schematic diagram representing the pipework system, so that readers can visualise passage through the pipes and the changes in taxa over space. Ultimately, this will have to be grouped/coloured by more manageable chunks than all the taxa I have listed. But even without that, it's clear that the Jassa amphipods dominate right the way through. It's also clear that there isn't a great deal surviving in the pipework areas sampled in the middle of the ship, but they do survive transit and settle and grow in the final stage before overboard discharge. 

```{r}
ggplot() +
  geom_bar(data = mean_density_stage,
           aes(x = stage, y = avg_density, fill = taxon_verified),
           stat = "identity",
           position = "stack") +
#  geom_line(data = mean_density_stage, #problem with line is that without 0 for stages where taxa are absent, it connects the line making it look like the density goes consistently up/down rather than sharp changes
#           aes(x = stage, y = avg_density, colour = taxon),
#           stat = "identity",
#           position = "stack") +
  theme(legend.position = "bottom")
```


Creating a heatmap with dendrograms
```{r}
library(heatmap3)
heat_map <- heatmap3(community_matrix)
heat_map
```
